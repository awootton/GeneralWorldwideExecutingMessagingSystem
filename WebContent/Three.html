<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My first Three.js Metaversenet app</title>
<style>
body {
	margin: 0;
}

canvas {
	width: 100%;
	height: 100%
}
</style>

</head>
<body>

	<div id="topInput">
		<textarea placeholder="W A S D controls are active. Shift speeds up"
			style="width: 440px; height: 12px;" id="message"></textarea>
		<input type="submit" id="send" value="send" />
	</div>

	<script src="http://code.jquery.com/jquery.min.js"></script>
	<script src="js/three.js"></script>
	<script src="js/libs/controls/OrbitControls.js" type="text/javascript"></script>
	<script src="js/libs/controls/AtwNoMouseFirstPersonControls.js"
		type="text/javascript"></script>
	<script src="js/js/atw_stats.js" type="text/javascript"></script>

	<script src="js/QuadSpaces.js" type="text/javascript"></script>
	<script src="js/GWEMS.js" type="text/javascript"></script>
	<script src="js/reconnecting-websocket.js"></script>

	<script>
		$("#send").click(function(event) {
			event.preventDefault();
			var msg = $("#message").val();
			//sock.send(msg);
		});
		
		var userName = (""+Math.random()).substring(3,9);
		console.log("our name will be " + userName)

		var hostName = location.hostname;
		console.log("Using host " + hostName);
		var sock = new GWEMS.WebSocketClient(hostName, 8081, "/");
		sock.start();

		var clock = new THREE.Clock();

		var scene = new THREE.Scene();
		var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

		camera.position.z = 5;
		camera.position.y = 1.5;
		camera.lookAt(0, 0, 0);

		var renderer = new THREE.WebGLRenderer();
		renderer.setSize(window.innerWidth, window.innerHeight);
		document.body.appendChild(renderer.domElement);

		var container = document.body;
		var stats = new Stats();
		stats.domElement.style.position = 'absolute';
		stats.domElement.style.bottom = '20px';
		stats.domElement.style.zIndex = 100;
		container.appendChild(stats.domElement);

		var ambient = new THREE.AmbientLight(0x222222);
		scene.add(ambient);

		var directionalLight = new THREE.DirectionalLight(0xFFFFFF, 0.75);
		directionalLight.position.set(10, 10, 10);
		scene.add(directionalLight);

		var geometry = new THREE.BoxGeometry(1, 1, 1);// one meter
		var material = new THREE.MeshLambertMaterial({
			color : 0x7777FF
		})
		var cube = new THREE.Mesh(geometry, material);
		cube.position.set(0.5, 0.5, 0.5);
		scene.add(cube);
		cube.lowestY = function(){
			return cube.position.y-0.5;
		}

		geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);// one meter
		material = new THREE.MeshLambertMaterial({
			color : 0x7777FF
		})
		var cube2 = new THREE.Mesh(geometry, material);
		cube2.position.set(1.25, 0.25, 1.25);
		scene.add(cube2);

		var floorTexture = new THREE.ImageUtils.loadTexture('images/ColoredKnives.jpg');
		floorTexture.minFilter = THREE.LinearFilter;
		floorTexture.wrapS = floorTexture.wrapT = THREE.RepeatWrapping;
		floorTexture.repeat.set(1, 1);

		floor = new THREE.Mesh(new THREE.BoxGeometry(3 * 3 * 3 * 3 * 3, 1, 3 * 3 * 3 * 3 * 3),
				new THREE.MeshBasicMaterial({
					map : floorTexture,
					color : 0x888899
				}));
		floor.position.set(0, -0.5, 0);
		scene.add(floor);

		var controls = new THREE.OrbitControls(camera, renderer.domElement);
		var drivecontrols = new THREE.AtwNoMouseFirstPersonControls(cube, renderer.domElement ,camera);

		var render = function() {
			requestAnimationFrame(render);
			renderer.render(scene, camera);
			var cubeBefore = new THREE.Vector3().copy(cube.position);
			controls.update();// needs delta
			drivecontrols.update(clock.getDelta());// needs delta

			// we need to pin cube.y-0.5 to terrain todo:	

			controls.target = cube.position;
			cubeBefore.sub(cube.position);
			camera.position.sub(cubeBefore);// follow it

			var str = "x=" + camera.position.x + "<br>";
			str += "y=" + camera.position.y + "<br>";
			str += "z=" + camera.position.z;

			var strList = QuadSpaces.decompose(camera.position, 0);

			var strList6 = QuadSpaces.decompose(camera.position, 6);

			stats.update(strList + "<br>" + strList6);//str);
		};

		render();
	</script>

</body>
</html>

